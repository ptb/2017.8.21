* Mac Setup
:properties:
:header-args: :cache yes :comments org :padline yes :results silent
:header-args:sh: :noweb tangle :shebang "#!/bin/sh" :tangle mac-setup.command
:end:
#+startup: showall nohideblocks hidestars indent

#+begin_quote
From zero to fully installed and configured, in an hour.
#+end_quote

** Overview

*** Quick Start
#+begin_src sh
case "${SHELL}" in
  (*zsh) ;;
  (*) chsh -s "$(which zsh)"; exit 1 ;;
esac
#+end_src

#+begin_example sh
curl --location --silent \
  "https://github.com/ptb/2017.8.21/raw/master/mac-setup.command" | \
  source /dev/stdin 0
#+end_example

#+begin_example sh
init && install_sw && config && custom
#+end_example

*** Walkthrough

**** Clone Internal Hard Disk to External Disk

**** Select the External Disk as Startup Disk

**** Download [[https://itunes.apple.com/app/id1209167288][macOS Install]] from the App Store

**** Open /Applications/Utilities/Terminal.app
#+begin_example sh
diskx="$(diskutil list internal physical | sed '/^\//!d;s/^\(.*\)\ (.*):/\1/')"
#+end_example

#+begin_example sh
diskutil zeroDisk $diskx
diskutil partitionDisk $diskx 2 GPT \
  jhfs+ "Install" 10G \
  apfs $(ruby -e "print '$(hostname -s)'.capitalize") R
#+end_example

#+begin_example sh
sudo "/Applications/Install macOS High Sierra.app/Contents/Resources/createinstallmedia" \
  --applicationpath "/Applications/Install macOS High Sierra.app" --nointeraction \
  --volume "/Volumes/Install"
#+end_example

**** Select the Install Disk as Startup Disk

*** License

#+begin_quote
Copyright 2017 [[https://github.com/ptb][Peter T Bosse II]]

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
#+end_quote

** Initialize

*** Initialize New Terminal
#+begin_src sh
if test -z "${1}"; then
  osascript - "${0}" << EOF > /dev/null 2>&1
<<new_term.applescript>>
EOF
fi
#+end_src

**** =new_term.applescript=
#+begin_src applescript :noweb-ref new_term.applescript
    on run { _this }
      tell app "Terminal" to do script "source " & quoted form of _this & " 0"
    end run
#+end_src

*** Define Function =ask=
#+begin_src sh
ask () {
  osascript - "${1}" "${2}" "${3}" << EOF 2> /dev/null
<<ask.applescript>>
EOF
}
#+end_src

**** =ask.applescript=
#+begin_src applescript :noweb-ref ask.applescript
    on run { _title, _action, _default }
      tell app "System Events" to return text returned of (display dialog _title with title _title buttons { "Cancel", _action } default answer _default)
    end run
#+end_src

*** Define Function =run=
#+begin_src sh
run () {
  osascript - "${1}" "${2}" "${3}" << EOF 2> /dev/null
<<run.applescript>>
EOF
}
#+end_src

**** =run.applescript=
#+begin_src applescript :noweb-ref run.applescript
    on run { _title, _cancel, _action }
      tell app "System Events" to return button returned of (display dialog _title with title _title buttons { _cancel, _action } cancel button 1 default button 2 giving up after 5)
    end run
#+end_src

*** Define Function =init=
#+begin_src sh
init () {
  init_sudo
  init_cache
  init_no_sleep
  init_hostname
  init_mas_save
  init_devtools "${CACHES}"
  init_updates

  which install_sw
}

if test "${1}" = 0; then
  printf "\n$(which init)\n"
fi
#+end_src

*** Eliminate Prompts for Password
#+begin_src sh
init_sudo () {
  printf "%s\n" "%wheel ALL=(ALL) NOPASSWD: ALL" | \
  sudo tee "/etc/sudoers.d/wheel" > /dev/null && \
  sudo dscl /Local/Default append /Groups/wheel GroupMembership "$(whoami)"
}
#+end_src

*** Select Installation Cache Location
#+begin_src sh
init_cache () {
  a=$(osascript << EOF 2> /dev/null
<<init_cache.applescript>>
EOF
)

  test -d "${a}" || \
    a="${HOME}/Library/Caches/"

  export CACHES="${a}"
  export HOMEBREW_CACHE="${a}Homebrew"
  export BREWFILE="${a}Homebrew/Brewfile"
}
#+end_src

**** =init_cache.applescript=
#+begin_src applescript :noweb-ref init_cache.applescript
    on run
      return POSIX path of (choose folder with prompt "Select Existing Installation Cache")
    end run
#+end_src

*** Set Defaults for Sleep
#+begin_src sh
init_no_sleep () {
  sudo pmset -a sleep 0
  sudo pmset -a disksleep 0
}
#+end_src

*** Set Hostname from DNS
#+begin_src sh
init_hostname () {
  sudo systemsetup -setcomputername \
    $(ruby -e "print '$(hostname -s)'.capitalize") > /dev/null
  sudo systemsetup -setlocalsubnetname $(hostname -s) > /dev/null
}
#+end_src

*** Save Mac App Store Packages
#+begin_example sh
sudo lsof -c softwareupdated -F -r 2 | sed '/^n\//!d;/com.apple.SoftwareUpdate/!d;s/^n//'
sudo lsof -c storedownloadd -F -r 2 | sed '/^n\//!d;/com.apple.appstore/!d;s/^n//'
#+end_example

#+begin_src sh :var _mas_save_plist=_mas_save_plist[3:-2,0:3]

function init_mas_save () {
  sudo softwareupdate --reset-ignored > /dev/null

  test -d "/usr/local/bin" || \
    sudo mkdir -p /usr/local/bin && \
    sudo chown /usr/local/bin

  cat << EOF > "/usr/local/bin/mas_save"
<<mas_save.sh>>
EOF

  chmod a+x "/usr/local/bin/mas_save"
  rehash

  la="/Library/LaunchDaemons/com.github.ptb.mas_save"
  as="$(getconf DARWIN_USER_CACHE_DIR)com.apple.appstore"
  su="$(sudo find "/private/var/folders" -name "com.apple.SoftwareUpdate" -type d -user _softwareupdate 2> /dev/null)"

  sudo mkdir -p "$(dirname ${la})"
  sudo launchctl unload "${la}.plist" 2> /dev/null
  sudo rm -f "${la}.plist"
  config_defaults "$(printf '%s\t%s\t%s\t%s\t' ${la} 'WatchPaths' '-array-add' ${as})" "sudo"
  config_defaults "$(printf '%s\t%s\t%s\t%s\t' ${la} 'WatchPaths' '-array-add' ${su})" "sudo"
  config_plist "${_mas_save_plist}" "${la}.plist" "" "sudo"
  sudo plutil -convert xml1 "${la}.plist"
  sudo launchctl load "${la}.plist" 2> /dev/null
}
#+end_src

**** _mas_save_plist
#+name: _mas_save_plist
|---------+------------+--------+-------------------------|
| Command | Entry      | Type   | Value                   |
|---------+------------+--------+-------------------------|
| add     | :KeepAlive | bool   | false                   |
| add     | :Label     | string | com.github.ptb.mas_save |
| add     | :Program   | string | /usr/local/bin/mas_save |
| add     | :RunAtLoad | bool   | true                    |
| add     | :UserName  | string | root                    |
|---------+------------+--------+-------------------------|

**** =/usr/local/bin/mas_save=
#+begin_src sh :noweb-ref mas_save.sh :tangle no
#!/bin/sh

asdir="/Users/Shared/storedownloadd"
as="$(getconf DARWIN_USER_CACHE_DIR)com.apple.appstore"

for i in 1 2 3 4 5; do
  mkdir -m a=rwxt -p "\${asdir}"
  find "\${as}" -iname "[0-9]*" -type d -print | \\
  while read a; do
    b="\${asdir}/\$(basename \$a)"
    mkdir -p "\${b}"
    find "\${a}" -type f -print | \\
    while read c; do
      d="\$(basename \$c)"
      test -e "\${b}/\${d}" || \\
        ln "\${c}" "\${b}/\${d}" && \\
        chmod 666 "\${b}/\${d}"
    done
  done

  sudir="/Users/Shared/softwareupdated"
  su="$(sudo find "/private/var/folders" -name "com.apple.SoftwareUpdate" -type d -user _softwareupdate 2> /dev/null)"

  mkdir -m a=rwxt -p "\${sudir}"
  find "\${su}" -name "*.tmp" -type f -print | \\
  while read a; do
    d="\$(basename \$a)"
    test -e "\${sudir}/\${d}.xar" ||
      ln "\${a}" "\${sudir}/\${d}.xar" && \\
      chmod 666 "\${sudir}/\${d}.xar"
  done

  sleep 1
done
#+end_src

*** Install Developer Tools
#+begin_src sh
init_devtools () {
  p="${1}/Command Line Tools (macOS High Sierra version 10.13).pkg"
  i="com.apple.pkg.CLTools_SDK_macOS1013"

  if test -f "${p}"; then
    if ! pkgutil --pkg-info "${i}" > /dev/null 2>&1; then
      sudo installer -pkg "${p}" -target /
    fi
  else
    xcode-select --install
  fi
}
#+end_src

*** Install macOS Updates
#+begin_src sh
init_updates () {
  sudo softwareupdate --install --all
}
#+end_src

** Install

*** Define Function =install_sw=
#+begin_src sh
install_sw () {
  install_paths
  install_brew
  install_brewfile_taps
  install_brewfile_brew_pkgs
  install_brewfile_cask_args
  install_brewfile_cask_pkgs
  install_brewfile_mas_apps
  install_brew_bundle
  # install_brew_built
  install_links
  install_node_sw
  install_perl_sw
  install_python_sw
  install_ruby_sw

  which config
}
#+end_src

*** Add =/usr/local/bin/sbin= to Default Path
#+begin_src sh
install_paths () {
  if ! grep -Fq "/usr/local/sbin" /etc/paths; then
    sudo sed -i -e "/\/usr\/sbin/{x;s/$/\/usr\/local\/sbin/;G;}" /etc/paths
  fi
}
#+end_src

*** Install Homebrew Package Manager
#+begin_src sh
install_brew () {
  if ! which brew > /dev/null; then
    ruby -e \
      "$(curl -Ls 'https://github.com/Homebrew/install/raw/master/install')" \
      < /dev/null > /dev/null 2>&1
    printf "" > "${BREWFILE}"
  fi
  brew analytics off
  brew update
  brew doctor
  brew tap "homebrew/bundle"
}
#+end_src

*** Add Homebrew Taps to Brewfile
#+begin_src sh :var _taps=_taps[3:-2,0]

install_brewfile_taps () {
  printf "%s\n" "${_taps}" | \
  while IFS="$(printf '\t')" read tap; do
    printf 'tap "%s"\n' "${tap}" >> "${BREWFILE}"
  done
  printf "\n" >> "${BREWFILE}"
}
#+end_src

**** _taps
#+name: _taps
|----------------------------+--------------------------------------------------------|
| Homebrew Tap Name          | Reference URL                                          |
|----------------------------+--------------------------------------------------------|
| caskroom/cask              | https://github.com/caskroom/homebrew-cask              |
| caskroom/fonts             | https://github.com/caskroom/homebrew-fonts             |
| caskroom/versions          | https://github.com/caskroom/homebrew-versions          |
| homebrew/bundle            | https://github.com/Homebrew/homebrew-bundle            |
| homebrew/command-not-found | https://github.com/Homebrew/homebrew-command-not-found |
| homebrew/nginx             | https://github.com/Homebrew/homebrew-nginx             |
| homebrew/php               | https://github.com/Homebrew/homebrew-php               |
| homebrew/services          | https://github.com/Homebrew/homebrew-services          |
| ptb/custom                 | https://github.com/ptb/homebrew-custom                 |
| railwaycat/emacsmacport    | https://github.com/railwaycat/homebrew-emacsmacport    |
|----------------------------+--------------------------------------------------------|

*** Add Homebrew Packages to Brewfile
#+begin_src sh :var _pkgs=_pkgs[3:-2,0]

install_brewfile_brew_pkgs () {
  printf "%s\n" "${_pkgs}" | \
  while IFS="$(printf '\t')" read pkg; do
    printf 'brew "%s", args: [ "force-bottle" ]\n' "${pkg}" >> "${BREWFILE}"
  done
  printf "\n" >> "${BREWFILE}"
}
#+end_src

**** _pkgs
#+name: _pkgs
|-----------------------+------------------------------------------|
| Homebrew Package Name | Reference URL                            |
|-----------------------+------------------------------------------|
| aspell                | http://aspell.net/                       |
| git                   | https://git-scm.com/                     |
| gnu-sed               | https://www.gnu.org/software/sed/        |
| gnupg                 | https://www.gnupg.org/                   |
| mas                   | https://github.com/argon/mas             |
| node                  | https://nodejs.org/                      |
| nodenv                | https://github.com/nodenv/nodenv         |
| openssl               | https://www.openssl.org/                 |
| perl-build            | https://github.com/tokuhirom/Perl-Build  |
| php71                 | https://github.com/Homebrew/homebrew-php |
| pinentry-mac          | https://github.com/GPGTools/pinentry-mac |
| plenv                 | https://github.com/tokuhirom/plenv       |
| pyenv                 | https://github.com/pyenv/pyenv           |
| rbenv                 | https://github.com/rbenv/rbenv           |
| rsync                 | https://rsync.samba.org/                 |
| shellcheck            | https://github.com/koalaman/shellcheck   |
| vim                   | https://vim.sourceforge.io/              |
| yarn                  | https://yarnpkg.com/                     |
| zsh                   | https://www.zsh.org/                     |
|-----------------------+------------------------------------------|

*** Add Caskroom Options to Brewfile
#+begin_src sh :var _args=_args[3:8,0:1]

install_brewfile_cask_args () {
  printf 'cask_args \' >> "${BREWFILE}"
  printf "%s\n" "${_args}" | \
  while IFS="$(printf '\t')" read arg dir; do
    printf '\n  %s: "%s",' "${arg}" "${dir}" >> "${BREWFILE}"
  done
  sed -i -e "$ s/,/$(printf '\n\n')/" "${BREWFILE}"
}
#+end_src

**** _args
#+name: _args
|-----------------+--------------------------|
| Location        | Install Path             |
|-----------------+--------------------------|
| fontdir         | /Library/Fonts           |
| colorpickerdir  | /Library/ColorPickers    |
| input_methoddir | /Library/Input Methods   |
| prefpanedir     | /Library/PreferencePanes |
| qlplugindir     | /Library/QuickLook       |
| screen_saverdir | /Library/Screen Savers   |
|-----------------+--------------------------|

*** Add Homebrew Casks to Brewfile
#+begin_src sh :var _casks=_casks[3:-2,0]

install_brewfile_cask_pkgs () {
  printf "%s\n" "${_casks}" | \
  while IFS="$(printf '\t')" read cask; do
    printf 'cask "%s"\n' "${cask}" >> "${BREWFILE}"
  done
  printf "\n" >> "${BREWFILE}"
}
#+end_src

**** _casks
#+name: _casks
|--------------------------------------------------+---------------------------------------------------------------|
| Caskroom Package Name                            | Reference URL                                                 |
|--------------------------------------------------+---------------------------------------------------------------|
| java                                             | https://www.oracle.com/technetwork/java/javase/               |
| xquartz                                          | https://www.xquartz.org/                                      |
| adium                                            | https://www.adium.im/                                         |
| alfred                                           | https://www.alfredapp.com/                                    |
| arduino                                          | https://www.arduino.cc/                                       |
| atom                                             | https://atom.io/                                              |
| autodmg                                          | https://github.com/MagerValp/AutoDMG                          |
| bbedit                                           | https://www.barebones.com/products/bbedit/                    |
| caffeine                                         | http://lightheadsw.com/caffeine/                              |
| carbon-copy-cloner                               | https://bombich.com/                                          |
| charles                                          | https://www.charlesproxy.com/                                 |
| dash                                             | https://kapeli.com/dash                                       |
| dropbox                                          | https://www.dropbox.com/                                      |
| duet                                             | https://www.duetdisplay.com/                                  |
| exifrenamer                                      | http://www.qdev.de/?location=mac/exifrenamer                  |
| firefox                                          | https://www.mozilla.org/firefox/                              |
| flux                                             | https://justgetflux.com/                                      |
| github-desktop                                   | https://desktop.github.com/                                   |
| gitup                                            | http://gitup.co/                                              |
| google-chrome                                    | https://www.google.com/chrome/                                |
| handbrake                                        | https://handbrake.fr/                                         |
| hermes                                           | http://hermesapp.org/                                         |
| imageoptim                                       | https://imageoptim.com/mac                                    |
| inkscape                                         | https://inkscape.org/                                         |
| integrity                                        | http://peacockmedia.software/mac/integrity/                   |
| istat-menus                                      | https://bjango.com/mac/istatmenus/                            |
| iterm2                                           | https://www.iterm2.com/                                       |
| jubler                                           | http://www.jubler.org/                                        |
| little-snitch                                    | https://www.obdev.at/products/littlesnitch/                   |
| machg                                            | http://jasonfharris.com/machg/                                |
| makemkv                                          | https://www.makemkv.com/                                      |
| menubar-countdown                                | http://capablehands.net/menubarcountdown                      |
| meteorologist                                    | http://heat-meteo.sourceforge.net/                            |
| moom                                             | https://manytricks.com/moom/                                  |
| mp4tools                                         | http://www.emmgunn.com/mp4tools-home/                         |
| munki                                            | https://www.munki.org/munki/                                  |
| musicbrainz-picard                               | https://picard.musicbrainz.org/                               |
| namechanger                                      | https://mrrsoftware.com/namechanger/                          |
| nvalt                                            | http://brettterpstra.com/projects/nvalt/                      |
| nzbget                                           | https://nzbget.net/                                           |
| nzbvortex                                        | https://www.nzbvortex.com/                                    |
| openemu                                          | http://openemu.org/                                           |
| opera                                            | https://www.opera.com/                                        |
| pacifist                                         | https://www.charlessoft.com/                                  |
| platypus                                         | https://sveinbjorn.org/platypus                               |
| plex-media-server                                | https://www.plex.tv/                                          |
| qlstephen                                        | https://whomwah.github.io/qlstephen/                          |
| quitter                                          | https://marco.org/apps#quitter                                |
| rescuetime                                       | https://www.rescuetime.com/                                   |
| scrivener                                        | https://literatureandlatte.com/scrivener.php                  |
| sizeup                                           | https://www.irradiatedsoftware.com/sizeup/                    |
| sketch                                           | https://www.sketchapp.com/                                    |
| sketchup                                         | https://www.sketchup.com/                                     |
| skitch                                           | https://evernote.com/products/skitch                          |
| skype                                            | https://www.skype.com/                                        |
| slack                                            | https://slack.com/                                            |
| sonarr                                           | https://sonarr.tv/                                            |
| sonarr-menu                                      | https://github.com/jefbarn/Sonarr-Menu                        |
| sourcetree                                       | https://www.sourcetreeapp.com/                                |
| steermouse                                       | http://plentycom.jp/en/steermouse/                            |
| subler                                           | https://subler.org/                                           |
| sublime-text                                     | https://www.sublimetext.com/3                                 |
| the-unarchiver                                   | https://theunarchiver.com/                                    |
| time-sink                                        | https://manytricks.com/timesink/                              |
| torbrowser                                       | https://www.torproject.org/projects/torbrowser.html           |
| tower                                            | https://www.git-tower.com/                                    |
| unrarx                                           | http://www.unrarx.com/                                        |
| vimr                                             | http://vimr.org/                                              |
| vlc                                              | https://www.videolan.org/vlc/                                 |
| vmware-fusion                                    | https://www.vmware.com/products/fusion.html                   |
| wireshark                                        | https://www.wireshark.org/                                    |
| xld                                              | http://tmkk.undo.jp/xld/index_e.html                          |
| caskroom/fonts/font-inconsolata-lgc              | https://github.com/DeLaGuardo/Inconsolata-LGC                 |
| caskroom/versions/transmit4                      | https://panic.com/transmit/                                   |
| ptb/custom/adobe-creative-cloud-2014             | https://www.adobe.com/creativecloud.html                      |
| ptb/custom/blankscreen                           | http://www.wurst-wasser.net/wiki/index.php/Blank_Screen_Saver |
| ptb/custom/composer                              | https://www.jamf.com/products/jamf-composer/                  |
| ptb/custom/ipmenulet                             | https://github.com/mcandre/IPMenulet                          |
| ptb/custom/pcalc-3                               | http://www.pcalc.com/english/about.html                       |
| ptb/custom/sketchup-pro                          | https://www.sketchup.com/products/sketchup-pro                |
| ptb/custom/synergy                               | https://wincent.com/products/synergy                          |
| railwaycat/emacsmacport/emacs-mac-spacemacs-icon | https://github.com/railwaycat/homebrew-emacsmacport           |
|--------------------------------------------------+---------------------------------------------------------------|

*** Add App Store Packages to Brewfile
#+begin_src sh :var _mas=_mas[3:-2,0:1]

install_brewfile_mas_apps () {
  open "/Applications/App Store.app"
  run "Sign in to the App Store with your Apple ID" "Cancel" "OK"
  printf "%s\n" "${_mas}" | \
  while IFS="$(printf '\t')" read app id; do
    printf 'mas "%s", id: %s\n' "${app}" "${id}" >> "${BREWFILE}"
  done
}
#+end_src

**** _mas
#+name: _mas
|-----------------+-----------+------------------------------------------|
| App Name        |    App ID | App Store URL                            |
|-----------------+-----------+------------------------------------------|
| 1Password       | 443987910 | https://itunes.apple.com/app/id443987910 |
| autoping        | 632347870 | https://itunes.apple.com/app/id632347870 |
| Coffitivity     | 659901392 | https://itunes.apple.com/app/id659901392 |
| Growl           | 467939042 | https://itunes.apple.com/app/id467939042 |
| HardwareGrowler | 475260933 | https://itunes.apple.com/app/id475260933 |
| I Love Stars    | 402642760 | https://itunes.apple.com/app/id402642760 |
| Icon Slate      | 439697913 | https://itunes.apple.com/app/id439697913 |
| Justnotes       | 511230166 | https://itunes.apple.com/app/id511230166 |
| Keynote         | 409183694 | https://itunes.apple.com/app/id409183694 |
| Metanota Pro    | 515250764 | https://itunes.apple.com/app/id515250764 |
| Numbers         | 409203825 | https://itunes.apple.com/app/id409203825 |
| Pages           | 409201541 | https://itunes.apple.com/app/id409201541 |
| WiFi Explorer   | 494803304 | https://itunes.apple.com/app/id494803304 |
|-----------------+-----------+------------------------------------------|

*** Install macOS Software with =brew bundle=
#+begin_src sh
install_brew_bundle () {
  brew bundle --file="${BREWFILE}"

  x="$(find '/Applications' -maxdepth 1 -name 'Xcode[^ ]*.app' -print -quit)"
  if test -n "${x}"; then
    sudo xcode-select -s "${x}"
    sudo xcodebuild -license accept
  fi
}
#+end_src

*** Add Compiled Packages to Brewfile
#+begin_src sh :var _built=_built[3:-2,0:1]

install_brew_built () {
  printf "%s\n" "${_built}" | \
  while IFS="$(printf '\t')" read pkg args; do
    brew install --build-bottle "${pkg}" ${args}
    brew bottle "${pkg}"
    brew postinstall "${pkg}"
  done
}
#+end_src

**** _built
#+name: _built
|---------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Homebrew Package Name     | Custom Build Arguments                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|---------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| dovecot                   | --with-pam --with-pigeonhole                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| homebrew/nginx/nginx-full | --with-dav-ext-module --with-fancyindex-module --with-gzip-static --with-http2 --with-mp4-h264-module --with-passenger --with-push-stream-module --with-secure-link --with-webdav                                                                                                                                                                                                                                                                                                                                                                                                       |
| ptb/custom/ffmpeg         | --with-chromaprint --with-fdk-aac --with-fontconfig --with-freetype --with-frei0r --with-game-music-emu --with-libass --with-libbluray --with-libbs2b --with-libcaca --with-libgsm --with-libmodplug --with-libsoxr --with-libssh --with-libvidstab --with-libvorbis --with-libvpx --with-opencore-amr --with-openh264 --with-openjpeg --with-openssl --with-opus --with-rtmpdump --with-rubberband --with-schroedinger --with-sdl2 --with-snappy --with-speex --with-tesseract --with-theora --with-tools --with-two-lame --with-wavpack --with-webp --with-x265 --with-xz --with-zimg |
|---------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

*** Link System Utilities to Applications
#+begin_src sh :var _links=_links[3:-2,0]

install_links () {
  brew linkapps 2> /dev/null
  printf "%s\n" "${_links}" | \
  while IFS="$(printf '\t')" read link; do
    find "${link}" -maxdepth 1 -name "*.app" -type d -print0 2> /dev/null | \
    xargs -0 -I {} -L 1 ln -s "{}" "/Applications" 2> /dev/null
  done
}
#+end_src

**** _links
#+name: _links
|--------------------------------------------------------------|
| Application Locations                                        |
|--------------------------------------------------------------|
| /System/Library/CoreServices/Applications                    |
| /Applications/Xcode.app/Contents/Applications                |
| /Applications/Xcode.app/Contents/Developer/Applications      |
| /Applications/Xcode-beta.app/Contents/Applications           |
| /Applications/Xcode-beta.app/Contents/Developer/Applications |
|--------------------------------------------------------------|

*** Install Node Software with =nodenv=
#+begin_src sh
install_node_sw () {
  if which nodenv > /dev/null; then
    sudo mkdir -p "/usr/local/node"
    sudo chown -R "$(whoami):admin" "/usr/local/node"
    test -f "/etc/zshenv" && \
    grep -q "NODENV_ROOT" "/etc/zshenv" || \
    printf "%s\n" \
      'export NODENV_ROOT="/usr/local/node"' | \
    sudo tee -a "/etc/zshenv" > /dev/null
    . "/etc/zshenv"

    test -f "/etc/zshrc" && \
    grep -q "nodenv" "/etc/zshrc" || \
    printf "%s\n" \
      'eval "$(nodenv init - zsh)"' | \
    sudo tee -a "/etc/zshrc" > /dev/null
    . "/etc/zshrc"

    nodenv install --skip-existing 8.3.0
    nodenv global 8.3.0
    rehash

    grep -q "${NODENV_ROOT}" "/etc/paths" || \
    sudo sed -i -e "1i\\
${NODENV_ROOT}/shims
" "/etc/paths"
  fi
}
#+end_src

*** Install Perl Software with =plenv=
#+begin_src sh
install_perl_sw () {
  if which plenv > /dev/null; then
    sudo mkdir -p "/usr/local/perl"
    sudo chown -R "$(whoami):admin" "/usr/local/perl"
    test -f "/etc/zshenv" && \
    grep -q "PLENV_ROOT" "/etc/zshenv" || \
    printf "%s\n" \
      'export PLENV_ROOT="/usr/local/perl"' | \
    sudo tee -a "/etc/zshenv" > /dev/null
    . "/etc/zshenv"

    test -f "/etc/zshrc" && \
    grep -q "plenv" "/etc/zshrc" || \
    printf "%s\n" \
      'eval "$(plenv init - zsh)"' | \
    sudo tee -a "/etc/zshrc" > /dev/null
    . "/etc/zshrc"

    plenv install 5.26.0 > /dev/null 2>&1
    plenv global 5.26.0
    rehash

    grep -q "${PLENV_ROOT}" "/etc/paths" || \
    sudo sed -i -e "1i\\
${PLENV_ROOT}/shims
" "/etc/paths"
  fi
}
#+end_src

*** Install Python Software with =pyenv=
#+begin_src sh
install_python_sw () {
  if which pyenv > /dev/null; then
    export CFLAGS="-I$(brew --prefix openssl)/include" \
    export LDFLAGS="-L$(brew --prefix openssl)/lib" \

    sudo mkdir -p "/usr/local/python"
    sudo chown -R "$(whoami):admin" "/usr/local/python"
    test -f "/etc/zshenv" && \
    grep -q "PYENV_ROOT" "/etc/zshenv" || \
    printf "%s\n" \
      'export PYENV_ROOT="/usr/local/python"' | \
    sudo tee -a "/etc/zshenv" > /dev/null
    . "/etc/zshenv"

    test -f "/etc/zshrc" && \
    grep -q "pyenv" "/etc/zshrc" || \
    printf "%s\n" \
      'eval "$(pyenv init - zsh)"' | \
    sudo tee -a "/etc/zshrc" > /dev/null
    . "/etc/zshrc"

    pyenv install --skip-existing 2.7.13
    pyenv install --skip-existing 3.6.2
    pyenv global 2.7.13
    rehash

    pip install --upgrade "pip" "setuptools"

    grep -q "${PYENV_ROOT}" "/etc/paths" || \
    sudo sed -i -e "1i\\
${PYENV_ROOT}/shims
" "/etc/paths"
  fi
}
#+end_src

*** Install Ruby Software with =rbenv=
#+begin_src sh
install_ruby_sw () {
  if which rbenv > /dev/null; then
    sudo mkdir -p "/usr/local/ruby"
    sudo chown -R "$(whoami):admin" "/usr/local/ruby"
    test -f "/etc/zshenv" && \
    grep -q "RBENV_ROOT" "/etc/zshenv" || \
    printf "%s\n" \
      'export RBENV_ROOT="/usr/local/ruby"' | \
    sudo tee -a "/etc/zshenv" > /dev/null
    . "/etc/zshenv"

    test -f "/etc/zshrc" && \
    grep -q "rbenv" "/etc/zshrc" || \
    printf "%s\n" \
      'eval "$(rbenv init - zsh)"' | \
    sudo tee -a "/etc/zshrc" > /dev/null
    . "/etc/zshrc"

    rbenv install --skip-existing 2.4.1
    rbenv global 2.4.1
    rehash

    printf "%s\n" \
      "gem: --no-document" | \
    tee "${HOME}/.gemrc" > /dev/null

    gem update --system
    yes | gem update
    gem install bundler

    grep -q "${RBENV_ROOT}" "/etc/paths" || \
    sudo sed -i -e "1i\\
${RBENV_ROOT}/shims
" "/etc/paths"
  fi
}
#+end_src

** Configure

*** Define Function =config=
#+begin_src sh
config () {
  config_bbedit
  config_desktop
  config_dovecot
  config_zsh

  which custom
}
#+end_src

*** Define Function =config_defaults=
#+begin_src sh
config_defaults () {
  printf "%s\n" "${1}" | \
  while IFS="$(printf '\t')" read domain key type value host; do
    ${2} defaults ${host} write ${domain} "${key}" ${type} "${value}"
  done
}
#+end_src

*** Define Function =config_plist=
#+begin_src sh
config_plist () {
  printf "%s\n" "${1}" | \
  while IFS="$(printf '\t')" read command entry type value; do
    ${4} /usr/libexec/PlistBuddy "${2}" \
      -c "${command} '${3}${entry}' ${type} '${value}'" 2> /dev/null
  done
}
#+end_src

*** Configure BBEdit
#+begin_src sh
config_bbedit () {
  if test -d "/Applications/BBEdit.app"; then
    test -f "/usr/local/bin/bbdiff" || \
    ln /Applications/BBEdit.app/Contents/Helpers/bbdiff /usr/local/bin/bbdiff && \
    ln /Applications/BBEdit.app/Contents/Helpers/bbedit_tool /usr/local/bin/bbedit && \
    ln /Applications/BBEdit.app/Contents/Helpers/bbfind /usr/local/bin/bbfind && \
    ln /Applications/BBEdit.app/Contents/Helpers/bbresults /usr/local/bin/bbresults
  fi
}
#+end_src

*** Configure Desktop Picture
#+begin_src sh
config_desktop () {
  sudo rm -f "/Library/Caches/com.apple.desktop.admin.png"

  base64 -D << EOF > "/Library/Caches/com.apple.desktop.admin.png"
<<black.png.b64>>
EOF
}
#+end_src

**** =black.png.b64=
#+begin_src base64 :noweb-ref black.png.b64
iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQAAAADrRVxmAAAAGElEQVR4AWOgMxgFo2AUjIJRMApGwSgAAAiAAAH3bJXBAAAAAElFTkSuQmCC
#+end_src

*** Configure Dovecot
#+begin_src sh
config_dovecot () {
  if which dovecot > /dev/null; then
    if ! run "Configure Dovecot Email Server?" "Configure Server" "Cancel"; then
      cat << EOF > "/usr/local/etc/dovecot/dovecot.conf"
<<dovecot.conf>>
EOF

      MAILADM="$(ask 'Email Administrator Address' 'Set Email' "$(whoami)@$(hostname)")"
      MAILSVR="$(ask 'Email Server DNS Hostname' 'Set Hostname' "$(hostname)")"
      SSL="$(brew --prefix openssl)"
      printf "%s\n" \
        "postmaster_address = '${MAILADM}'" \
        "ssl_cert = <${SSL}/certs/${MAILSVR}/${MAILSVR}.crt" \
        "ssl_key = <${SSL}/certs/${MAILSVR}/${MAILSVR}.key" | \
      tee -a "/usr/local/etc/dovecot/dovecot.conf" > /dev/null

      if test ! -f "/usr/local/etc/dovecot/cram-md5.pwd"; then
        while true; do
          MAILUSR="$(ask 'Username for New Email Account?' 'Create Account' "$(whoami)")"
          test -n "${MAILUSR}" || break
          doveadm pw | \
          sed -e "s/^/${MAILUSR}:/" | \
          sudo tee -a "/usr/local/etc/dovecot/cram-md5.pwd"
        done
        sudo chown _dovecot "/usr/local/etc/dovecot/cram-md5.pwd"
        sudo chmod go= "/usr/local/etc/dovecot/cram-md5.pwd"
      fi

      sudo tee "/etc/pam.d/dovecot" << EOF > /dev/null
<<dovecot.pam>>
EOF

      grep -Fq "${MAILSVR}" "/etc/hosts" || \
      printf "%s\t%s\n" "127.0.0.1" "${MAILSVR}" | \
      sudo tee -a "/etc/hosts" > /dev/null

      sudo brew services start dovecot

      cat << EOF > "/usr/local/bin/imaptimefix.py"
<<imaptimefix.py>>
EOF
      chmod +x /usr/local/bin/imaptimefix.py
    fi
  fi
}
#+end_src

**** =/usr/local/etc/dovecot/dovecot.conf=
#+begin_src conf :noweb-ref dovecot.conf
auth_mechanisms = cram-md5
default_internal_user = _dovecot
default_login_user = _dovenull
log_path = /dev/stderr
mail_location = maildir:~/.mail:INBOX=~/.mail/Inbox:LAYOUT=fs
mail_plugins = zlib
maildir_copy_with_hardlinks = no
namespace {
  inbox = yes
  mailbox Drafts {
    auto = subscribe
    special_use = \Drafts
  }
  mailbox Junk {
    auto = subscribe
    special_use = \Junk
  }
  mailbox Sent {
    auto = subscribe
    special_use = \Sent
  }
  mailbox "Sent Messages" {
    special_use = \Sent
  }
  mailbox Trash {
    auto = subscribe
    special_use = \Trash
  }
  separator = .
  type = private
}
passdb {
  args = scheme=cram-md5 /usr/local/etc/dovecot/cram-md5.pwd
  driver = passwd-file

  # driver = pam

  # args = nopassword=y
  # driver = static
}
plugin {
  sieve = file:/Users/%u/.sieve
  sieve_plugins = sieve_extprograms
  zlib_save = bz2
  zlib_save_level = 9
}
protocols = imap
service imap-login {
  inet_listener imap {
    port = 0
  }
}
ssl = required
ssl_cipher_list = AES128+EECDH:AES128+EDH
ssl_dh_parameters_length = 4096
ssl_prefer_server_ciphers = yes
ssl_protocols = !SSLv2 !SSLv3
userdb {
  driver = passwd
}
protocol lda {
  mail_plugins = sieve zlib
}

# auth_debug = yes
# auth_debug_passwords = yes
# auth_verbose = yes
# auth_verbose_passwords = plain
# mail_debug = yes
# verbose_ssl = yes
#+end_src

**** =/etc/pam.d/dovecot=
#+begin_src conf :noweb-ref dovecot.pam
auth	required	pam_opendirectory.so	try_first_pass
account	required	pam_nologin.so
account	required	pam_opendirectory.so
password	required	pam_opendirectory.so
#+end_src

**** =/usr/local/bin/imaptimefix.py=
#+begin_src python :noweb-ref imaptimefix.py
#!/usr/bin/env python

# Author: Zachary Cutlip <@zcutlip>
# http://shadow-file.blogspot.com/2012/06/parsing-email-and-fixing-timestamps-in.html
# Updated: Peter T Bosse II <@ptb>
# Purpose: A program to fix sorting of mail messages that have been POPed or
#          IMAPed in the wrong order. Compares time stamp sent and timestamp
#          received on an RFC822-formatted email message, and renames the
#          message file using the most recent timestamp that is no more than
#          24 hours after the date sent. Updates the file's atime/mtime with
#          the timestamp, as well. Does not modify the headers or contents of
#          the message.

from bz2 import BZ2File
from email import message_from_string
from email.utils import mktime_tz, parsedate_tz
from os import rename, utime, walk
from os.path import abspath, isdir, isfile, join
from re import compile, match
from sys import argv

if isdir(argv[1]):
  e = compile("([0-9]+)(\..*$)")

  for a, b, c in walk(argv[1]):
    for d in c:
      if e.match(d):
        f = message_from_string(BZ2File(join(a, d)).read())
        g = mktime_tz(parsedate_tz(f.get("Date")))

        h = 0
        for i in f.get_all("Received", []):
          j = i.split(";")[-1]
          if parsedate_tz(j):
            k = mktime_tz(parsedate_tz(j))
            if (k - g) > (60*60*24):
              continue

            h = k
          break

        if (h < 1):
          h = g

        l = e.match(d)

        if len(l.groups()) == 2:
          m = str(int(h)) + l.groups()[1]
          if not isfile(join(a, m)):
            rename(join(a, d), join(a, m))
          utime(join(a, m), (h, h))
#+end_src

*** Configure Z-Shell
#+begin_src sh
config_zsh () {
  sudo tee -a /etc/zshenv << EOF > /dev/null
<<zshenv>>
EOF
  sudo chmod +x "/etc/zshenv"
  . "/etc/zshenv"
}
#+end_src

**** =/etc/zshenv=
#+begin_src sh :noweb-ref zshenv :tangle no
export ZDOTDIR="${HOME}/.zsh"
export MASDIR="\$(getconf DARWIN_USER_CACHE_DIR)com.apple.appstore"

export EDITOR="vi"
export VISUAL="vi"
export PAGER="less"

test -z "${LANG}" && \
  export LANG="en_US.UTF-8"

# Ensure path arrays do not contain duplicates.
typeset -gU cdpath fpath mailpath path

# Set the default Less options.
export LESS="-egiMQRS -x2 -z-2"
#+end_src

** Customize

*** Define Function =custom=
#+begin_src sh
custom () {
  custom_home
  custom_atom
  custom_emacs
  custom_terminal
  custom_zsh
}
#+end_src

*** Customize Home
#+begin_src sh
custom_home () {
  a=$(ask "Existing Home Repository Path or URL" "Add Remote" "")

  if test -n "${a}"; then
    git -C "${HOME}" init
    git -C "${HOME}" remote add origin "${a}"
    git -C "${HOME}" pull origin master
  fi

  chmod -R go= "${HOME}" > /dev/null 2>&1
}
#+end_src

*** Customize Atom
#+begin_src sh :var _atom=_atom[3:-2,0]

custom_atom () {
  if which apm > /dev/null; then
    mkdir -p "${HOME}/.atom/.apm"

    cat << EOF > "${HOME}/.atom/.apmrc"
cache = ${CACHES}/apm
EOF

    cat << EOF > "${HOME}/.atom/.apm/.apmrc"
cache = ${CACHES}/apm
EOF

    printf "%s\n" "${_atom}" | \
    while IFS="$(printf '\t')" read pkg; do
      test -d "${HOME}/.atom/packages/${pkg}" ||
      apm install "${pkg}"
    done

    cat << EOF > "${HOME}/.atom/config.cson"
<<config.cson>>
EOF

    cat << EOF > "${HOME}/.atom/packages/tomorrow-night-eighties-syntax/styles/colors.less"
<<colors.less>>
EOF
  fi
}
#+end_src

**** _atom
#+name: _atom
|--------------------------------+---------------------------------------------------------|
| Atom Package Name              | Reference URL                                           |
|--------------------------------+---------------------------------------------------------|
| atom-beautify                  | https://atom.io/packages/atom-beautify                  |
| atom-css-comb                  | https://atom.io/packages/atom-css-comb                  |
| atom-jade                      | https://atom.io/packages/atom-jade                      |
| atom-wallaby                   | https://atom.io/packages/atom-wallaby                   |
| autoclose-html                 | https://atom.io/packages/autoclose-html                 |
| autocomplete-python            | https://atom.io/packages/autocomplete-python            |
| busy-signal                    | https://atom.io/packages/busy-signal                    |
| double-tag                     | https://atom.io/packages/double-tag                     |
| editorconfig                   | https://atom.io/packages/editorconfig                   |
| ex-mode                        | https://atom.io/packages/ex-mode                        |
| file-icons                     | https://atom.io/packages/file-icons                     |
| git-plus                       | https://atom.io/packages/git-plus                       |
| git-time-machine               | https://atom.io/packages/git-time-machine               |
| highlight-selected             | https://atom.io/packages/highlight-selected             |
| intentions                     | https://atom.io/packages/intentions                     |
| language-docker                | https://atom.io/packages/language-docker                |
| language-jade                  | https://atom.io/packages/language-jade                  |
| language-javascript-jsx        | https://atom.io/packages/language-javascript-jsx        |
| language-lisp                  | https://atom.io/packages/language-lisp                  |
| language-slim                  | https://atom.io/packages/language-slim                  |
| linter                         | https://atom.io/packages/linter                         |
| linter-eslint                  | https://atom.io/packages/linter-eslint                  |
| linter-rubocop                 | https://atom.io/packages/linter-rubocop                 |
| linter-shellcheck              | https://atom.io/packages/linter-shellcheck              |
| linter-ui-default              | https://atom.io/packages/linter-ui-default              |
| MagicPython                    | https://atom.io/packages/MagicPython                    |
| python-yapf                    | https://atom.io/packages/python-yapf                    |
| react                          | https://atom.io/packages/react                          |
| riot                           | https://atom.io/packages/riot                           |
| sort-lines                     | https://atom.io/packages/sort-lines                     |
| term3                          | https://atom.io/packages/term3                          |
| tomorrow-night-eighties-syntax | https://atom.io/packages/tomorrow-night-eighties-syntax |
| tree-view-open-files           | https://atom.io/packages/tree-view-open-files           |
| vim-mode-plus                  | https://atom.io/packages/vim-mode-plus                  |
| vim-mode-zz                    | https://atom.io/packages/vim-mode-zz                    |
|--------------------------------+---------------------------------------------------------|

**** =${HOME}/.atom/config.cson=
#+begin_src cson :noweb-ref config.cson
"*":
  "autocomplete-python":
    useKite: false
  core:
    telemetryConsent: "limited"
    themes: [
      "one-dark-ui"
      "tomorrow-night-eighties-syntax"
    ]
  editor:
    fontFamily: "Inconsolata LGC"
    fontSize: 13
  welcome:
    showOnStartup: false
#+end_src

**** =${HOME}/.atom/packages/tomorrow-night-eighties-syntax/styles/colors.less=
#+begin_src less :noweb-ref colors.less
@background: #222222;
@current-line: #333333;
@selection: #4c4c4c;
@foreground: #cccccc;
@comment: #999999;
@red: #f27f7f;
@orange: #ff994c;
@yellow: #ffcc66;
@green: #99cc99;
@aqua: #66cccc;
@blue: #6699cc;
@purple: #cc99cc;
#+end_src

*** Customize Emacs
#+begin_src sh
custom_emacs () {
  mkdir -p "${HOME}/.emacs.d" && \
  curl --compressed --location --silent \
    "https://github.com/syl20bnr/spacemacs/archive/master.tar.gz" | \
  tar -C "${HOME}/.emacs.d" --strip-components 1 -xf -
  mkdir -p "${HOME}/.emacs.d/private/ptb"
  chmod -R go= "${HOME}/.emacs.d"

  cat << EOF > "${HOME}/.spacemacs"
<<.spacemacs>>
EOF

  cat << EOF > "${HOME}/.emacs.d/private/ptb/config.el"
<<config.el>>
EOF

  cat << EOF > "${HOME}/.emacs.d/private/ptb/funcs.el"
<<funcs.el>>
EOF

  cat << EOF > "${HOME}/.emacs.d/private/ptb/keybindings.el"
<<keybindings.el>>
EOF

  cat << EOF > "${HOME}/.emacs.d/private/ptb/packages.el"
<<packages.el>>
EOF

  cat << EOF > "/usr/local/bin/vi"
<<vi.sh>>
EOF

  chmod a+x /usr/local/bin/vi
  rehash
}
#+end_src

**** =~/.spacemacs=
#+begin_src emacs-lisp :noweb-ref .spacemacs
(defun dotspacemacs/layers ()
  (setq-default
    dotspacemacs-configuration-layers '(
      auto-completion
      (colors :variables
        colors-colorize-identifiers 'variables)
      dash
      deft
      docker
      emacs-lisp
      evil-cleverparens
      git
      github
      helm
      html
      ibuffer
      imenu-list
      javascript
      markdown
      nginx
      (org :variables
        org-enable-github-support t)
      (osx :variables
        osx-use-option-as-meta nil)
      ptb
      react
      ruby
      ruby-on-rails
      search-engine
      semantic
      shell-scripts
      (spell-checking :variables
        spell-checking-enable-by-default nil)
      syntax-checking
      (version-control :variables
        version-control-diff-side 'left)
      vim-empty-lines
    )
    dotspacemacs-excluded-packages '(org-bullets)
  )
)

(defun dotspacemacs/init ()
  (setq-default
    dotspacemacs-startup-banner nil
    dotspacemacs-startup-lists nil
    dotspacemacs-scratch-mode 'org-mode
    dotspacemacs-themes '(sanityinc-tomorrow-eighties)
    dotspacemacs-default-font '(
      "Inconsolata LGC"
      :size 13
      :weight normal
      :width normal
      :powerline-scale 1.1)
    dotspacemacs-loading-progress-bar nil
    dotspacemacs-active-transparency 100
    dotspacemacs-inactive-transparency 100
    dotspacemacs-line-numbers t
    dotspacemacs-whitespace-cleanup 'all
  )
)

(defun dotspacemacs/user-init ())
(defun dotspacemacs/user-config ())
#+end_src

**** =~/.emacs.d/private/ptb/config.el=
#+begin_src emacs-lisp :noweb-ref config.el
(setq
  default-frame-alist '(
    (top . 22)
    (left . 1279)
    (height . 48)
    (width . 123)
    (vertical-scroll-bars . right))
  initial-frame-alist (copy-alist default-frame-alist)

  deft-directory "~/Dropbox/Notes"
  focus-follows-mouse t
  mouse-wheel-follow-mouse t
  mouse-wheel-scroll-amount '(1 ((shift) . 1))
  org-src-preserve-indentation t
  purpose-display-at-right 20
  recentf-max-saved-items 5
  scroll-step 1
  system-uses-terminfo nil

  ibuffer-formats '(
    (mark modified read-only " "
    (name 18 18 :left :elide)))

  ibuffer-shrink-to-minimum-size t
  ibuffer-always-show-last-buffer nil
  ibuffer-sorting-mode 'recency
  ibuffer-use-header-line nil
  x-select-enable-clipboard nil)

(global-linum-mode t)
(recentf-mode t)
(x-focus-frame nil)
(with-eval-after-load 'org
  (org-babel-do-load-languages
    'org-babel-load-languages '(
      (ruby . t)
      (shell . t)
    )
  )
)
#+end_src

**** =~/.emacs.d/private/ptb/funcs.el=
#+begin_src emacs-lisp :noweb-ref funcs.el
(defun is-useless-buffer (buffer)
  (let ((name (buffer-name buffer)))
    (and (= ?* (aref name 0))
        (string-match "^\\**" name))))

(defun kill-useless-buffers ()
  (interactive)
  (loop for buffer being the buffers
        do (and (is-useless-buffer buffer) (kill-buffer buffer))))

(defun org-babel-tangle-hook ()
  (add-hook 'after-save-hook 'org-babel-tangle))

(add-hook 'org-mode-hook #'org-babel-tangle-hook)

(defun ptb/new-untitled-buffer ()
  "Create a new untitled buffer in the current frame."
  (interactive)
  (let
    ((buffer "Untitled-") (count 1))
    (while
      (get-buffer (concat buffer (number-to-string count)))
      (setq count (1+ count)))
    (switch-to-buffer
    (concat buffer (number-to-string count))))
  (org-mode))

(defun ptb/previous-buffer ()
  (interactive)
  (kill-useless-buffers)
  (previous-buffer))

(defun ptb/next-buffer ()
  (interactive)
  (kill-useless-buffers)
  (next-buffer))

(defun ptb/kill-current-buffer ()
  (interactive)
  (kill-buffer (current-buffer))
  (kill-useless-buffers))
#+end_src

**** =~/.emacs.d/private/ptb/keybindings.el=
#+begin_src emacs-lisp :noweb-ref keybindings.el
(define-key evil-insert-state-map (kbd "<return>") 'newline)

(define-key evil-normal-state-map (kbd "s-c") 'clipboard-kill-ring-save)
(define-key evil-insert-state-map (kbd "s-c") 'clipboard-kill-ring-save)
(define-key evil-visual-state-map (kbd "s-c") 'clipboard-kill-ring-save)

(define-key evil-ex-completion-map (kbd "s-v") 'clipboard-yank)
(define-key evil-ex-search-keymap (kbd "s-v") 'clipboard-yank)
(define-key evil-insert-state-map (kbd "s-v") 'clipboard-yank)

(define-key evil-normal-state-map (kbd "s-x") 'clipboard-kill-region)
(define-key evil-insert-state-map (kbd "s-x") 'clipboard-kill-region)
(define-key evil-visual-state-map (kbd "s-x") 'clipboard-kill-region)

(define-key evil-normal-state-map (kbd "<S-up>") 'evil-previous-visual-line)
(define-key evil-insert-state-map (kbd "<S-up>") 'evil-previous-visual-line)
(define-key evil-visual-state-map (kbd "<S-up>") 'evil-previous-visual-line)

(define-key evil-normal-state-map (kbd "<S-down>") 'evil-next-visual-line)
(define-key evil-insert-state-map (kbd "<S-down>") 'evil-next-visual-line)
(define-key evil-visual-state-map (kbd "<S-down>") 'evil-next-visual-line)

(global-set-key (kbd "C-l") 'evil-search-highlight-persist-remove-all)

(global-set-key (kbd "s-t") 'make-frame)
(global-set-key (kbd "s-n") 'ptb/new-untitled-buffer)
(global-set-key (kbd "s-w") 'ptb/kill-this-buffer)
(global-set-key (kbd "s-{") 'ptb/previous-buffer)
(global-set-key (kbd "s-}") 'ptb/next-buffer)
#+end_src

**** =~/.emacs.d/private/ptb/packages.el=
#+begin_src emacs-lisp :noweb-ref packages.el
(setq ptb-packages '(adaptive-wrap auto-indent-mode))

(defun ptb/init-adaptive-wrap ()
  "Load the adaptive wrap package"
  (use-package adaptive-wrap
    :init
    (setq adaptive-wrap-extra-indent 2)
    :config
    (progn
      ;; http://stackoverflow.com/questions/13559061
      (when (fboundp 'adaptive-wrap-prefix-mode)
        (defun ptb/activate-adaptive-wrap-prefix-mode ()
          "Toggle 'visual-line-mode' and 'adaptive-wrap-prefix-mode' simultaneously."
          (adaptive-wrap-prefix-mode (if visual-line-mode 1 -1)))
        (add-hook 'visual-line-mode-hook 'ptb/activate-adaptive-wrap-prefix-mode)))))

(defun ptb/init-auto-indent-mode ()
  (use-package auto-indent-mode
    :init
    (setq
      auto-indent-delete-backward-char t
      auto-indent-fix-org-auto-fill t
      auto-indent-fix-org-move-beginning-of-line t
      auto-indent-fix-org-return t
      auto-indent-fix-org-yank t
      auto-indent-start-org-indent t
    )
  )
)
#+end_src

**** =/usr/local/bin/vi=
#+begin_src sh :noweb-ref vi.sh :tangle no
#!/bin/sh

if [ -e "/Applications/Emacs.app" ]; then
  t=()

  if [ \${#@} -ne 0 ]; then
    while IFS= read -r file; do
      [ ! -f "\$file" ] && t+=("\$file") && /usr/bin/touch "\$file"
      file=\$(echo \$(cd \$(dirname "\$file") && pwd -P)/\$(basename "\$file"))
      \$(/usr/bin/osascript <<-END
        if application "Emacs.app" is running then
          tell application id (id of application "Emacs.app") to open POSIX file "\$file"
        else
          tell application ((path to applications folder as text) & "Emacs.app")
            activate
            open POSIX file "\$file"
          end tell
        end if
END
        ) &  # Note: END on the previous line may be indented with tabs but not spaces
    done <<<"\$(printf '%s\n' "\$@")"
  fi

  if [ ! -z "\$t" ]; then
    \$(/bin/sleep 10; for file in "\${t[@]}"; do
      [ ! -s "\$file" ] && /bin/rm "\$file";
    done) &
  fi
else
  vim -No "\$@"
fi
#+end_src

*** Customize Terminal
#+begin_src sh :var _term_plist=_term_plist[3:-2,1:4] :var _term_defaults=_term_defaults[3:-2,1:5]

custom_terminal () {
  config_plist "${_term_plist}" \
    "${HOME}/Library/Preferences/com.apple.Terminal.plist" \
    ":Window Settings:ptb"
  config_defaults "${_term_defaults}"
}
#+end_src

**** _term_plist
#+name: _term_plist
|------------+---------+---------------------------------------+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Preference | Command | Entry                                 | Type    | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|------------+---------+---------------------------------------+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|            | delete  |                                       |         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|            | add     |                                       | dict    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|            | add     | :name                                 | string  | ptb                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|            | add     | :type                                 | string  | Window Settings                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|            | add     | :ProfileCurrentVersion                | real    | 2.05                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :BackgroundColor                      | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC4xIDAuMSAwLjE=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :BackgroundBlur                       | real    | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :BackgroundSettingsForInactiveWindows | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :BackgroundAlphaInactive              | real    | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :BackgroundBlurInactive               | real    | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :Font                                 | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>3</integer></dict><key>NSName</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSSize</key><real>13</real><key>NSfFlags</key><integer>16</integer></dict><string>InconsolataLGC</string><dict><key>$classes</key><array><string>NSFont</string><string>NSObject</string></array><key>$classname</key><string>NSFont</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist> |
|            | add     | :FontWidthSpacing                     | real    | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :FontHeightSpacing                    | real    | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :FontAntialias                        | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :UseBoldFonts                         | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :BlinkText                            | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :DisableANSIColor                     | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :UseBrightBold                        | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :TextColor                            | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC44IDAuOCAwLjg=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :TextBoldColor                        | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC44IDAuOCAwLjg=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :SelectionColor                       | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC4zIDAuMyAwLjM=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIBlackColor                       | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC4zIDAuMyAwLjM=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIRedColor                         | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC45NSAwLjUgMC41</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIGreenColor                       | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC42IDAuOCAwLjY=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIYellowColor                      | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MSAwLjggMC40</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBlueColor                        | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC40IDAuNiAwLjg=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIMagentaColor                     | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC44IDAuNiAwLjg=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSICyanColor                        | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC40IDAuOCAwLjg=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIWhiteColor                       | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC44IDAuOCAwLjg=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIBrightBlackColor                 | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC41IDAuNSAwLjU=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ANSIBrightRedColor                   | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MSAwLjcgMC43</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBrightGreenColor                 | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC44IDEgMC44</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBrightYellowColor                | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MSAxIDAuNg==</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBrightBlueColor                  | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC42IDAuOCAx</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBrightMagentaColor               | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MSAwLjggMQ==</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBrightCyanColor                  | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC42IDEgMQ==</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                     |
|            | add     | :ANSIBrightWhiteColor                 | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC45IDAuOSAwLjk=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :CursorType                           | integer | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :CursorBlink                          | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :CursorColor                          | data    | <?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>$archiver</key><string>NSKeyedArchiver</string><key>$objects</key><array><string>$null</string><dict><key>$class</key><dict><key>CF$UID</key><integer>2</integer></dict><key>NSColorSpace</key><integer>1</integer><key>NSRGB</key><data>MC43IDAuNyAwLjc=</data></dict><dict><key>$classes</key><array><string>NSColor</string><string>NSObject</string></array><key>$classname</key><string>NSColor</string></dict></array><key>$top</key><dict><key>root</key><dict><key>CF$UID</key><integer>1</integer></dict></dict><key>$version</key><integer>100000</integer></dict></plist>                                                                                 |
|            | add     | :ShowRepresentedURLInTitle            | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :ShowRepresentedURLPathInTitle        | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :ShowActiveProcessInTitle             | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :ShowActiveProcessArgumentsInTitle    | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowShellCommandInTitle              | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowWindowSettingsNameInTitle        | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowTTYNameInTitle                   | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowDimensionsInTitle                | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowCommandKeyInTitle                | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :columnCount                          | integer | 124                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|            | add     | :rowCount                             | integer | 20                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|            | add     | :ShouldLimitScrollback                | integer | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :ScrollbackLines                      | integer | 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :ShouldRestoreContent                 | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowRepresentedURLInTabTitle         | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowRepresentedURLPathInTabTitle     | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowActiveProcessInTabTitle          | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :ShowActiveProcessArgumentsInTabTitle | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowTTYNameInTabTitle                | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ShowComponentsWhenTabHasCustomTitle  | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :ShowActivityIndicatorInTab           | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :shellExitAction                      | integer | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :warnOnShellCloseAction               | integer | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :useOptionAsMetaKey                   | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :ScrollAlternateScreen                | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :TerminalType                         | string  | xterm-256color                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|            | add     | :deleteSendsBackspace                 | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :EscapeNonASCIICharacters             | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :ConvertNewlinesOnPaste               | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :StrictVTKeypad                       | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :scrollOnInput                        | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :Bell                                 | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :VisualBell                           | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :VisualBellOnlyWhenMuted              | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :BellBadge                            | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :BellBounce                           | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :BellBounceCritical                   | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|            | add     | :CharacterEncoding                    | integer | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|            | add     | :SetLanguageEnvironmentVariables      | bool    | true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|            | add     | :EastAsianAmbiguousWide               | bool    | false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|------------+---------+---------------------------------------+---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

**** _term_defaults
#+name: _term_defaults
|------------+--------------------+-------------------------+---------+-------+------|
| Preference | Domain             | Key                     | Type    | Value | Host |
|------------+--------------------+-------------------------+---------+-------+------|
|            | com.apple.Terminal | Startup Window Settings | -string | ptb   |      |
|            | com.apple.Terminal | Default Window Settings | -string | ptb   |      |
|------------+--------------------+-------------------------+---------+-------+------|

*** Customize Z-Shell
#+begin_src sh
custom_zsh () {
  mkdir -m go= "${ZDOTDIR:-$HOME}"
  cat << EOF > "${ZDOTDIR:-$HOME}/.zshrc"
<<zshrc>>
EOF
  chmod +x "${ZDOTDIR:-$HOME}/.zshrc"
}
#+end_src

**** =${ZDOTDIR:-$HOME}/.zshrc=
#+begin_src sh :noweb-ref zshrc :tangle no
#!/bin/sh

curl --location --silent \
  "https://github.com/ptb/2017.8.21/raw/master/mac-setup.command" | \
  . /dev/stdin 1
#+end_src
